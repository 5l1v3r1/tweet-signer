<html>
  <head>
    <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet">

    <style>
      html, body {
        height: 100%
      }

      body {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      form {
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 5px;
        width: 400px;
      }

      button {
        width: 100%
      }
    </style>

  </head>

  <body>
    <form id="urlform" action="">
      <div class="mb-4">
        <label class="block text-gray-700 text-sm font-bold mb-2" for="url">
          Tweet URL
        </label>
        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight" id="url" type="text" placeholder="https://twitter.com/..."></input>
      </div>
      <div class="flex items-center justify-between">
        <button class="bg-blue-500 text-white font-bold py-2 px-4 rounded" type="submit">
          Fetch
        </button>
      </div>
    </form>

    <form id="form" action="">
      <div class="mb-4">
        <label class="block text-gray-700 text-sm font-bold mb-2" for="pubkey">
          Public Key
        </label>
        <textarea rows=10 class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight" id="pubkey" type="text" placeholder="------ BEGIN RSA PUBLIC KEY ------"></textarea>
      </div>

      <div class="mb-4">
        <label class="block text-gray-700 text-sm font-bold mb-2" for="tweet">
          Tweet
        </label>
        <textarea rows=10 class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight" id="tweet" type="text"></textarea>
      </div>

      <div class="hidden mb-4">
        <label class="block text-gray-700 text-sm font-bold mb-2" for="qr">
          QR Code
        </label>
        <img crossorigin="" class="object-scale-down h-200 w-full" src="https://placekitten.com/327/293" id="qr"></img>
      </div>

      <div class="mb-4">
        <label class="block text-gray-700 text-sm font-bold mb-2" for="signature">
          Signature
        </label>
        <textarea rows=10 class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight" id="signature" type="text"></textarea>
      </div>

      <div class="flex items-center justify-between">
        <button class="bg-blue-500 text-white font-bold py-2 px-4 rounded" type="submit">
          Verify
        </button>
      </div>

      <br />
      <div class="bg-blue-100 border-t border-b border-blue-500 text-blue-700 px-4 py-3" role="alert">
        <p id="text" class="text-sm"></p>
      </div>

    </form>

    <script>
      (function() {
        let tweet, signature, pubkey;

        document.getElementById('urlform').addEventListener('submit', async function(e) {
          e.preventDefault();

          let bio, qrurl;
          try {
            let url = document.getElementById('url').value;
            url = url.replace('twitter.com', 'nitter.tuxcanfly.me'); // REMOVE

            const response = await fetch(url);
            const json = await response.json();
            tweet = json.tweet.text;
            bio = json.tweet.profile.bio;
            if (json.tweet.photos.length !== 1) {
              throw new Error("Must have exactly one attached photo.");
            }
            qrurl = json.tweet.photos[0];
            document.getElementById('tweet').value = tweet
          } catch (e) {
            document.getElementById('text').textContent = e;
          }

          try {
            const src = "https://nitter.tuxcanfly.me/pic/" + qrurl;
            document.getElementById('qr').src = src;

            const codeReader = new ZXing.BrowserQRCodeReader()
            const img = document.getElementById('qr')
            const result = await codeReader.decodeFromImage(img);
            signature = result.text;
            document.getElementById('signature').textContent = signature;
          } catch (e) {
            document.getElementById('text').textContent = e;
          }

          try {
            const match = bio.match(/https?:\/\/\w+.\w+\/\w+\.key/g);
            if (match === null) {
              throw new Error("Public key url must end with .key");
            }
            const url = match[0];
            const response = await fetch(url)
            pubkey = await response.text();
            document.getElementById('pubkey').value = pubkey;
          } catch (e) {
            document.getElementById('text').textContent = e;
          }
        });

        document.getElementById('form').addEventListener('submit', async function(e) {
          e.preventDefault();
          tweet = document.getElementById('tweet').value;
          pubkey = document.getElementById('pubkey').value;
          signature = document.getElementById('signature').value;
          try {
            const verified = bcrypto.verify(tweet, pubkey, signature);
            let status;
            if (verified) {
              status = 'Verified Tweet ✅';
            } else {
              status = 'Verification failed ❌';
            }
            document.getElementById('text').textContent = status;
          } catch (e) {
            document.getElementById('text').textContent = e;
          }
        });
      }());
    </script>

    <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>
    <script type="text/javascript" src="./static/bcrypto.bundle.js"></script>
  </body>

</html>
